<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="graph-viz">
  <template>
    <style>
      :host {
        display: block;
      }
      #graph {
        position: absolute;
        top:0; left:0; right:0; height: 50%;
      }
    </style>

    <div on-addnode="handleAddNode" on-addnodes="handleAddNodes">
      <div id="graph"></div>
      <content></content>
    </div>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'graph-viz',
      ready: function() {
        this.g = cytoscape({
          container: this.$.graph,
          ready: function(){ console.log('ready') },
          style: cytoscape.stylesheet()
            .selector('node')
            .css({
              'content': 'data(name)',
              'text-valign': 'center',
              'color': 'white',
              'text-outline-width': 2,
              'text-outline-color': '#888'
            })
        });

        this.circleLayout = {
          name: 'circle',

          fit: true, // whether to fit the viewport to the graph
          padding: 10, // the padding on fit
          boundingBox: {
            x1: 50,
            x2: 500,
            y1: 50,
            y2: 500
          }
          , // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
          avoidOverlap: true, // prevents node overlap, may overflow boundingBox and radius if not enough space
          radius: 100, // the radius of the circle
          startAngle: 3/2 * Math.PI, // the position of the first node
          counterclockwise: false, // whether the layout should go counterclockwise (true) or clockwise (false)
          //sort: undefined, // a sorting function to order the nodes; e.g. function(a, b){ return a.data('weight') - b.data('weight') }
          animate: true, // whether to transition the node positions
          animationDuration: 500, // duration of animation in ms if enabled
          ready: undefined, // callback on layoutready
          stop: undefined // callback on layoutstop
        }

        //this.g.layout(layout)
      },

      //listeners : { "addNode": "handleAddNode" },

      handleAddNode: function(ev, data) {
        //this.pushNode(data.id, data.label, 300, 300, 5, "#000")

        this.g.add({
          group: "nodes",
          data: {
            id: data.id,
            name: data.label
          },
          position: {x: 300, y: 300}
        })

        //this.reDraw()

        ev.srcElement["callbackEvent_"+ev.type](data)
      },
      reDraw: function() {
        //this.g.load()
        //this.g.refresh()
        //this.g.renderers[0].resize()
      },
      handleAddNodes: function(ev, data) {
        //console.log("NODES ", data)

        var that = this
        var toAdd = data.nodes.map(function(e) {

          var x = 300 + (Math.random() - 0.5) * 200
          var y = 300 + (Math.random() - 0.5) * 200

          //return [
            that.pushNode(e.id, e.label, x, y, 5, 'black')
            //that.pushNode({ group: "nodes", data: {id: e.id, label: {content : e.label}, position:{x: x, y: y}} })
          //, { group: "edges", data: {id: e.id+data.parentId, source: data.parentId, target: e.id } }
            that.pushEdge(e.id+data.parentId, data.parentId, e.id)

          //]
        })

        //this.push(_.flatten(toAdd))

        console.log(this.g)

        this.reDraw()

        this.g.layout(this.circleLayout)
      },
      push(data) {
        console.log(data)
        this.g.add(data)
      },
      pushNode(id, lbl, x, y, size, color) {
        this.g.add({group: "nodes", data: {id: id, name: lbl}
          , position: {x: x, y: y}
        })
      },
      pushEdge(id, src, dest) {
        this.g.add({group: "edges", data: {id: id, source: src, target: dest}})
      },
      properties: {
      }
    });
  })();
  </script>
</dom-module>

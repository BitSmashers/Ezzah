<dom-module id="media-search">
  <style>
    :host {
      display: block;
    }

    .search_container {
      margin-top: 50%;
      padding: 20px;
      background-color: white;
    }
  </style>
  <template>

    <div on-nodeselect="handleSelectNode">
      <paper-material class="search_container" elevation="1">
        <template is="dom-if" if="{{searching}}">
          <paper-input on-keydown="keyDown" value="{{search::input}}"></paper-input>
        </template>
        <template is="dom-if" if="{{!searching}}">
          <h3>{{search}}</h3>
          <paper-dialog-scrollable>
            <ul>
              <template is="dom-repeat" items="{{results}}">
                <li><media-result elem="{{item}}"></media-result></li>
              </template>
            </ul>
          </paper-dialog-scrollable>
        </template>

      </paper-material>

      <iron-ajax
         auto
         url="{{search_url}}"
         handle-as="json"
         on-response="handleResults"
         debounce-duration="300"></iron-ajax>
    </div>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'media-search',
        computeUrl: function(s) {
          //return "https://www.googleapis.com/media/v3/search?q="+s+"&part=snippet&key=AIzaSyCjHL3fQcfHvny-XEnLyGJ8rrxeCtnqOew"
          return "search/"+s

        },
        properties: {
          results: {
            type: Array,
            notify: true,
          },
          searching: {
            type: Boolean,
            value: true
          },
          search_url: {
            type: String,
            value: ''
          },
          related_url: {
            type: String,
            computed: 'computeRealtedUrl()'
          },
          artist_selected : {
            type: String,
            notify: true,
            observer: 'selectedUpdate'
          }
        },
        ready: function() {
        },
        keyDown: function(ev) {
          if(ev.keyCode == 13) {
            console.log(ev)
            this.searching = false
            this.search_url = this.computeUrl(this.search)
          }
        },
        handleSelectNode: function(evt, data) {
          console.log(">>>>>>>>>>SELECTED")
          console.log(evt)
          console.log(data)
        },
        selectedUpdate: function() {
          this.loadRelated(this.artist_selected)

          var that = this
          pegasus("http://localhost:9000/releases/"+this.artist_selected).then(function(data) {
            var lst = _(data.releases).map(function(e) {
              return { name: e.title, id: e.id, tracks:
                [{title : "NO TRACK"},
                {title : "NO TRACK 2"}]}
            }).value()

            console.log("RELEASES", lst, this, that)

            that.results = lst

            that.results.map(function(e) {
              pegasus("http://localhost:9000/tracks/"+e.id).then(function(data) {
                var idx = _.findIndex(that.results, function(x) { return x.id == e.id } )

                var res = _.cloneDeep(that.results)//[idx]
                res[idx].tracks = data.media[0].tracks
                that.results = res

                console.log("GOT TRACKS!!!", that.results)

              })
            })
          })
        },
        handleResults: function(ev) {
          if(ev.detail.response != null) {
            var res = ev.detail.response["artist-list"].artist
              if(res.length > 0) {
                this.fire('addnode', {
                  'label'  : res[0].name,
                  'id'  : res[0].id
                })

                this.artist_selected = res[0].id
              }
          }
        },
        loadRelated: function(id) {
          console.log(id)

          var that = this
          pegasus("http://localhost:9000/related/"+id).then(function(data) {
            var lst = _(data.recordings).map(function(e) {
              return e["artist-credit"]
            })
            .flatten()
            .groupBy(function(e) { return e.artist.id })
            .map(function(e) { return e[0] })
            .filter(function(e) { return e.artist.id != id })
            .value()

            console.log("--RELATED_-", lst)
            var nodes = lst.map ( function(s) {
              return { id: s.artist.id, label: s.artist.name }
            })

            that.fire('addnodes', {
              'nodes'  : nodes,
              'parentId'  : id
            })
          })
        }
      });
    })();
  </script>

</dom-module>
